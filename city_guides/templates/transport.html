<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Public Transport - TravelLand</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/static/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-50 text-gray-900 font-sans">
    <div class="fixed top-4 left-4 z-50">
        <a href="/" class="bg-white/90 backdrop-blur p-3 rounded-full shadow-lg hover:shadow-xl transition-all flex items-center justify-center border border-gray-100" title="Back to Home">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
            </svg>
        </a>
    </div>

    <header class="relative h-64 flex items-center justify-center text-white overflow-hidden bg-blue-600">
        <div class="absolute inset-0 bg-blue-900/40 z-10"></div>
        <img src="{{ banner_url or 'https://images.unsplash.com/photo-1544620347-c4fd4a3d5957?auto=format&fit=crop&q=80&w=2000' }}" alt="Transport" class="absolute inset-0 w-full h-full object-cover">
        {% if banner_attr %}
        <div class="absolute bottom-2 right-3 z-30 text-xs text-white/90 bg-black/30 px-2 py-1 rounded">{{ banner_attr }}</div>
        {% endif %}
        <div class="relative z-20 text-center">
            <h1 class="text-4xl md:text-5xl font-bold mb-2">Transport in {{ city_display or city }}</h1>
            <p class="text-xl opacity-90">Navigate {{ city_display or city }} like a local</p>
        </div>
    </header>

    <!-- No-key info notice -->
    <div class="max-w-4xl mx-auto px-4 mt-4">
        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded-lg text-yellow-800 text-sm">
            <strong>Note:</strong> This transport hub works without API keys â€” the "Open Google Transit Map" link is a deep-link and does not require a key. Marco's tips will be richer if a server-side AI key is configured, but will fall back to helpful generic guidance when none is present.
        </div>
    </div>

    <main class="max-w-4xl mx-auto px-4 py-12">
        <!-- AI Tips Section -->
        <section id="ai-transit-tips" class="mb-12 bg-gradient-to-br from-blue-600 to-blue-800 text-white p-8 rounded-3xl shadow-xl relative overflow-hidden">
            <div class="relative z-10">
                <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
                    <span class="text-3xl">ðŸ§­</span> Marco's Transit Tips
                </h2>
                <div id="marco-tips-content" class="prose prose-invert max-w-none">
                    <p class="animate-pulse">Marco is consulting his maps for {{ city }}...</p>
                    {% if GROQ_ENABLED %}
                        <p class="mt-3 text-sm opacity-90">Marco: enhanced reasoning enabled (Groq)</p>
                    {% else %}
                        <p class="mt-3 text-sm opacity-90">Marco: running in fallback mode (no Groq API key configured)</p>
                    {% endif %}
                </div>
            </div>
            <div class="absolute top-[-20px] right-[-20px] opacity-10">
                <svg width="200" height="200" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71L12 2z"/></svg>
            </div>
        </section>

        <section class="grid md:grid-cols-2 gap-8 mb-12">
            <div id="quick-guide" class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                <div class="flex items-center gap-4 mb-4">
                    <div class="bg-blue-100 p-3 rounded-xl text-blue-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                    <h2 class="text-xl font-bold">Quick Guide</h2>
                    </div>
                    <div id="quick-guide-list" class="space-y-3 text-gray-600">
                        <p>Loading quick guideâ€¦</p>
                    </div>
                    {% if initial_quick_guide %}
                    <script>
                    document.addEventListener('DOMContentLoaded', ()=>{
                        try{
                            const initial = {{ initial_quick_guide|tojson|safe }};
                            if(initial){
                                const q = document.getElementById('quick-guide-list');
                                const sentences = initial.match(/[^\.\!\?]+[\.\!\?]+/g) || [initial];
                                q.innerHTML = sentences.slice(0,4).map(b => `<div class="flex gap-3"><span class="text-blue-500 font-bold">â€¢</span><span>${b.trim()}</span></div>`).join('');
                            }
                        }catch(e){}
                    });
                    </script>
                    {% endif %}
            </div>

            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                <div class="flex items-center gap-4 mb-4">
                    <div class="bg-green-100 p-3 rounded-xl text-green-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" />
                        </svg>
                    </div>
                    <h2 class="text-xl font-bold">Transit Map</h2>
                </div>
                <p class="text-gray-600 mb-4">View real-time lines and schedules in <strong>{{ city }}</strong>.</p>
                <div id="map-container" class="relative group">
                    <div class="h-32 bg-blue-50 rounded-xl flex flex-col items-center justify-center border-2 border-blue-100 group-hover:bg-blue-100 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-blue-500 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" />
                        </svg>
                        <a id="transit-map-link" href="#" target="_blank" class="text-blue-600 font-bold hover:underline">Open Google Transit Map</a>
                    </div>
                </div>
            </div>
        </section>

        <section class="bg-white p-8 rounded-2xl shadow-sm border border-gray-100 mb-12">
            <h2 class="text-2xl font-bold mb-6">Crime & Safety Tips</h2>
            <p class="text-gray-600">Practical safety guidance for visitors â€” local scams, areas to avoid, and common-sense precautions. This is best-effort and should not replace official advisories.</p>
            <div id="safety-tips-list" class="mt-4 space-y-2 text-gray-700">
                <p>Loading safety tipsâ€¦</p>
            </div>
            <div class="mt-4 text-sm text-gray-500">Recommended sources: local police, official tourism sites, Wikivoyage/Wikipedia, and community reports.</div>
            <div id="us-advisory-block" class="mt-4 text-sm text-gray-600"></div>
        </section>

        {% if initial_safety_tips %}
        <script>
        document.addEventListener('DOMContentLoaded', ()=>{
            try{
                const raw = {{ initial_safety_tips|tojson|safe }};
                const el = document.getElementById('safety-tips-list');
                if(!el) return;
                let bullets = [];
                if(Array.isArray(raw)){
                    bullets = raw;
                } else if (typeof raw === 'string'){
                    bullets = raw.match(/[^\.\!\?]+[\.\!\?]+/g) || raw.split('\n').filter(Boolean);
                } else if (raw && typeof raw === 'object'){
                    bullets = (raw.answer || raw.text || JSON.stringify(raw)).match(/[^\.\!\?]+[\.\!\?]+/g) || [];
                }
                if(!bullets || !bullets.length) return;
                el.innerHTML = bullets.slice(0,5).map(b => `<div class="flex gap-3"><span class="text-red-500 font-bold">â€¢</span><span>${b.trim()}</span></div>`).join('');
            }catch(e){}
        });
        </script>
        {% endif %}

        {% if initial_us_advisory %}
        <script>
        document.addEventListener('DOMContentLoaded', ()=>{
            try{
                const adv = {{ initial_us_advisory|tojson|safe }};
                const block = document.getElementById('us-advisory-block');
                if(!block || !adv) return;
                const url = adv.url || '#';
                const summary = adv.summary || '';
                block.innerHTML = `<div class="bg-yellow-50 border-l-4 border-yellow-400 p-3 rounded"><strong>US State Dept advisory:</strong> ${summary ? summary : ''} <a href="${url}" target="_blank" class="text-blue-600 underline ml-2">Read full advisory</a></div>`;
            }catch(e){}
        });
        </script>
        {% endif %}

        <section class="text-center bg-gray-900 text-white p-12 rounded-3xl">
            <h2 class="text-3xl font-bold mb-4">Need a tailored route?</h2>
            <p class="text-gray-400 mb-8 max-w-lg mx-auto">Marco can help you figure out the best lines to reach your destination. Just ask him back on the home page!</p>
            <a href="/" class="inline-block px-8 py-3 bg-white text-gray-900 rounded-full font-bold hover:bg-blue-50 transition-colors">
                Back to Explorer
            </a>
        </section>
    </main>

    <footer class="text-center py-8 text-gray-400 text-sm">
        &copy; 2026 TravelLand City Guides. Stay mobile.
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            setupMapLinks();
            fetchMarcoTips();
            fetchTransportData();
            fetchCityInfoFallback();
            renderSampleDestinations();
        });

        // global city center used by quick-destination buttons
        window.__CITY_CENTER = {lat: null, lon: null};

        function makeDirectionsLink(originLat, originLon, destination) {
            if (originLat && originLon && originLat !== 'None') {
                const origin = `${originLat},${originLon}`;
                return `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(origin)}&destination=${encodeURIComponent(destination)}&travelmode=transit`;
            }
            return `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(destination)}&travelmode=transit`;
        }

        async function fetchTransportData() {
            const city = "{{ city }}";
            try {
                const resp = await fetch(`/api/transport?city=${encodeURIComponent(city)}`);
                if (!resp.ok) return;
                const j = await resp.json();
                applyTransportPayload(j);
            } catch (e) {
                console.warn('transport fetch failed', e);
            }
        }

        function applyTransportPayload(payload) {
            try {
                // Fill quick guide
                const q = document.getElementById('quick-guide-list');
                const sum = payload.wikivoyage_summary || '';
                if (sum) {
                    // take first 4 sentences as quick bullets
                    const sentences = sum.match(/[^\.\!\?]+[\.\!\?]+/g) || [sum];
                    const bullets = sentences.slice(0,4).map(s => s.trim());
                    q.innerHTML = bullets.map(b => `<div class="flex gap-3"><span class="text-blue-500 font-bold">â€¢</span><span>${b}</span></div>`).join('');
                } else {
                    q.innerHTML = '<p>No quick guide available.</p>';
                }

                // Update transit map link to payload center if available
                if (payload.center && payload.center.lat && payload.center.lon) {
                    const mapLink = document.getElementById('transit-map-link');
                    // if a dest param is present, prefer a directions link
                    const urlParams = new URLSearchParams(window.location.search);
                    const destParam = urlParams.get('dest');
                    if (destParam) {
                        mapLink.href = makeDirectionsLink(payload.center.lat, payload.center.lon, destParam);
                    } else {
                        mapLink.href = `https://www.google.com/maps/@${payload.center.lat},${payload.center.lon},13z/data=!5m1!1e2`;
                    }
                    // expose city center for quick-destination buttons
                    try {
                        window.__CITY_CENTER.lat = payload.center.lat;
                        window.__CITY_CENTER.lon = payload.center.lon;
                    } catch (e) {}
                }

                // Optionally show counts or stops somewhere â€” add a small badge
                if (payload.stops && payload.stops.length) {
                    const tips = document.getElementById('marco-tips-content');
                    const note = document.createElement('p');
                    note.className = 'mt-3 text-sm opacity-80';
                    note.textContent = `${payload.stops.length} nearby transport stops discovered.`;
                    tips.appendChild(note);
                }
                // Render provider links
                try {
                    const pl = document.getElementById('provider-links');
                    if (pl) {
                        const links = payload.provider_links || [];
                        if (links.length) {
                            pl.innerHTML = links.map(l => `<div><a href="${l.url}" target="_blank" class="text-blue-600 hover:underline font-semibold">${l.name}</a></div>`).join('');
                        } else {
                            pl.innerHTML = '';
                        }
                    }
                } catch (e) { console.warn(e); }
            } catch (e) {
                console.warn('applyTransportPayload failed', e);
            }
        }

        // Fallback: ask server for city info (quick guide + Marco) when transport JSON not present
        async function fetchCityInfoFallback() {
            const city = "{{ city }}";
            if (!city || city === 'the city') return;
            try {
                const resp = await fetch(`/api/city_info?city=${encodeURIComponent(city)}`);
                if (!resp.ok) return;
                const j = await resp.json();
                // populate quick guide if empty
                const q = document.getElementById('quick-guide-list');
                if (q && (!q.innerText || q.innerText.includes('Loading quick guide'))) {
                    if (j.quick_guide) {
                        const sentences = j.quick_guide.match(/[^\.\!\?]+[\.\!\?]+/g) || [j.quick_guide];
                        const bullets = sentences.slice(0,4).map(s => s.trim());
                        q.innerHTML = bullets.map(b => `<div class="flex gap-3"><span class="text-blue-500 font-bold">â€¢</span><span>${b}</span></div>`).join('');
                    }
                }
                // populate Marco if empty
                const marcoDiv = document.getElementById('marco-tips-content');
                if (marcoDiv && j.marco && (!marcoDiv.innerText || marcoDiv.innerText.includes('Marco is consulting'))) {
                    let html = (j.marco.answer || j.marco || '').toString().replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
                    marcoDiv.innerHTML = `<div class="bg-white/10 p-4 rounded-xl border border-white/20">${html}</div>`;
                }
                // update map link
                if (j.lat && j.lon) {
                    const mapLink = document.getElementById('transit-map-link');
                    const urlParams = new URLSearchParams(window.location.search);
                    const destParam = urlParams.get('dest');
                    if (destParam) {
                        mapLink.href = makeDirectionsLink(j.lat, j.lon, destParam);
                    } else {
                        mapLink.href = `https://www.google.com/maps/@${j.lat},${j.lon},13z/data=!5m1!1e2`;
                    }
                    try {
                        window.__CITY_CENTER.lat = j.lat;
                        window.__CITY_CENTER.lon = j.lon;
                    } catch (e) {}
                } else if (j.google_map) {
                    const mapLink = document.getElementById('transit-map-link');
                    mapLink.href = j.google_map;
                }
                // provider links from city_info
                try {
                    const pl = document.getElementById('provider-links');
                    if (pl) {
                        const links = j.provider_links || [];
                        if (links.length) {
                            pl.innerHTML = links.map(l => `<div><a href="${l.url}" target="_blank" class="text-blue-600 hover:underline font-semibold">${l.name}</a></div>`).join('');
                        }
                    }
                } catch (e) { console.warn(e); }

                // safety tips from city_info
                try {
                    const st = document.getElementById('safety-tips-list');
                    if (st) {
                        const raw = j.safety_tips || [];
                        let bullets = [];
                        if (Array.isArray(raw)) {
                            bullets = raw;
                        } else if (typeof raw === 'string') {
                            bullets = raw.match(/[^\.\!\?]+[\.\!\?]+/g) || raw.split('\n').filter(Boolean);
                        } else if (raw && typeof raw === 'object') {
                            bullets = (raw.answer || raw.text || JSON.stringify(raw)).match(/[^\.\!\?]+[\.\!\?]+/g) || [];
                        }
                        if (bullets && bullets.length) {
                            st.innerHTML = bullets.slice(0,5).map(p => `<div class="flex gap-3"><span class="text-red-500 font-bold">â€¢</span><span>${p.trim()}</span></div>`).join('');
                        } else {
                            st.innerHTML = '<p>No specific safety tips available. Stay aware, avoid poorly-lit areas, and keep valuables secure.</p>';
                        }
                    }
                } catch (e) { console.warn(e); }

                // US State Dept advisory from city_info
                try {
                    const advBlock = document.getElementById('us-advisory-block');
                    if (advBlock && j.us_state_advisory) {
                        const adv = j.us_state_advisory;
                        const url = adv.url || '#';
                        const summary = adv.summary || '';
                        advBlock.innerHTML = `<div class="bg-yellow-50 border-l-4 border-yellow-400 p-3 rounded"><strong>US State Dept advisory:</strong> ${summary ? summary : ''} <a href="${url}" target="_blank" class="text-blue-600 underline ml-2">Read full advisory</a></div>`;
                    }
                } catch (e) { console.warn(e); }
            } catch (e) {
                console.warn('fetchCityInfoFallback failed', e);
            }
        }

        function renderSampleDestinations() {
            const city = "{{ city }}".trim();
            const target = document.getElementById('sample-dests');
            if (!target) return;
            const samples = {
                'paris': ['Eiffel Tower','Gare du Nord','Charles de Gaulle Airport'],
                'shanghai': ['The Bund','Shanghai Tower','Pudong Airport'],
                'london': ['King\'s Cross','Heathrow Airport','London Bridge'],
                'new york': ['Times Square','JFK Airport','Grand Central Terminal'],
                'tokyo': ['Shibuya Crossing','Tokyo Station','Haneda Airport']
            };
            const key = city.toLowerCase();
            const list = samples[key] || ['Central Station','Airport','Main Attraction'];
            target.innerHTML = list.map(d => `<button class="px-3 py-2 bg-blue-50 text-blue-700 rounded-lg border border-blue-100 hover:bg-blue-100" data-dest="${encodeURIComponent(d)}">${d}</button>`).join(' ');
            // attach handlers
            target.querySelectorAll('button').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const dest = decodeURIComponent(e.currentTarget.getAttribute('data-dest'));
                    const origin = window.__CITY_CENTER || {};
                    const link = makeDirectionsLink(origin.lat, origin.lon, dest);
                    window.open(link, '_blank');
                });
            });
        }

        function setupMapLinks() {
            const city = "{{ city }}";
            const lat = "{{ lat }}";
            const lon = "{{ lon }}";
            const mapLink = document.getElementById('transit-map-link');
            const urlParams = new URLSearchParams(window.location.search);
            const destParam = urlParams.get('dest');

            function makeDirectionsLink(originLat, originLon, destination) {
                if (originLat && originLon) {
                    const origin = `${originLat},${originLon}`;
                    return `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(origin)}&destination=${encodeURIComponent(destination)}&travelmode=transit`;
                }
                return `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(destination)}&travelmode=transit`;
            }
            
            if (lat && lon && lat !== "None") {
                if (destParam) {
                    mapLink.href = makeDirectionsLink(lat, lon, destParam);
                } else {
                    mapLink.href = `https://www.google.com/maps/@${lat},${lon},14z/data=!5m1!1e2`;
                }
            } else {
                if (destParam) {
                    mapLink.href = makeDirectionsLink(null, null, destParam);
                } else {
                    mapLink.href = `https://www.google.com/maps/search/${encodeURIComponent(city + ' public transport')}/data=!5m1!1e2`;
                }
            }
        }

        async function fetchMarcoTips() {
            const city = "{{ city }}";
            const content = document.getElementById('marco-tips-content');
            if (city === "the city" || !city) {
                content.innerHTML = "<p>Search for a city on the home page to get specific transit tips!</p>";
                return;
            }

            try {
                const resp = await fetch('/semantic-search', {
                    method: 'POST',
                    headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({
                        q: `How do I get around ${city}? Name the primary transit app or website used by locals (e.g. TfL, RATP, MTA) and give 3 quick survival tips.`,
                        city: city,
                        mode: 'explorer'
                    })
                });
                const j = await resp.json();
                if (j.answer) {
                    // Basic markdown to html for common Marco formatting
                    let html = j.answer.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                                      .replace(/\n/g, '<br>');
                    content.innerHTML = `<div class="bg-white/10 p-4 rounded-xl border border-white/20">${html}</div>`;
                } else {
                    content.innerHTML = "<p>Marco is unsure about the routes here. Try the local kiosks!</p>";
                }
            } catch (e) {
                content.innerHTML = "<p>My compass is spinning! (Error fetching tips)</p>";
            }
        }

        function calculateFare() {
            const price = parseFloat(document.getElementById('ticketType').value);
            const count = parseInt(document.getElementById('peopleCount').value);
            const total = (price * count).toFixed(2);
            const res = document.getElementById('fareResult');
            res.textContent = `Estimated Total Cost: $${total}`;
            res.classList.remove('hidden');
        }
    </script>
</body>
</html>
